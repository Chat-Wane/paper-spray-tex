
\small
\SetKwProg{Function}{function}{}{}
\DontPrintSemicolon
\LinesNumbered

\Function{loop}{ % \comm{Every $\Delta\,t$}
  $\mathcal{P} \leftarrow incrementAge(\mathcal{P})$ \;
  \textbf{let} $ \langle q,\, age \rangle \leftarrow getOldest(\mathcal{P})$ \;
  \textbf{let} $sample \leftarrow $ \label{line:samplesize} $\smash{getSample(\mathcal{P}\setminus\left\{\langle q, age\rangle\right\}, \left \lceil{|\mathcal{P}|\div{2}} \right \rceil-1) \uplus \left\{\langle p, 0 \rangle\right\}}$ \;
  $sample \leftarrow replace(sample,\,q,\,p)$; \label{line:replace1} \;
  \textbf{let} $sample' \leftarrow sendTo(q,\, 'exchange',\, sample))$ \;
  \lWhile {$(\neg timeout(sample') \wedge \neg sample')$} {$waitForQ$}
  %    \hfill \Comment{Awaiting $q$'s sample}
  \If {$\neg timeout(sample')$} {
     $sample' \leftarrow replace(sample',\,p,\,q)$ \;
     $\mathcal{P} \leftarrow (\mathcal{P} \setminus sample) \uplus sample'$
  } \Else {
     $onPeerDown(q)$ \hfill \Comment{see Algorithm~\ref{algo:unreachable}}
  }
}


\Function{onExchange}{$o,\, sample$} { %  \hfill \comm{$o: origin$}
  \textbf{let} $\smash{sample' \leftarrow getSample(\mathcal{P} ,\, \left\lceil |\mathcal{P}|\div{2} \right\rceil )}$ \;
  $sample' \leftarrow replace(sample',\,o,\,p)$ \label{line:replace2} \;
  $sendTo(o ,\, sample')$ \; 
  $sample' \leftarrow replace(sample',\,p,\,o)$ \;
  $\mathcal{P} \leftarrow (\mathcal{P} \setminus sample') \uplus sample$ \;
}
