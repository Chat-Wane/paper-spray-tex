
\small
\algrenewcommand{\algorithmiccomment}[1]{\hskip2em$\rhd$ #1}

\newcommand{\comment}[1]{$\rhd$ #1}


\algblockdefx[initially]{initially}{endInitially}
  [0] {\textbf{INITIALLY:}} 

\algblockdefx[act]{act}{endAct}
  [0] {\textbf{ACTIVE THREAD:}}

\algblockdefx[pas]{pas}{endPas}
  [0] {\textbf{PASSIVE THREAD:}}


\newcommand{\LINEFOR}[2]{%
  \algorithmicfor\ {#1}\ \algorithmicdo\ {#2} %
  }

\newcommand{\LINEIFTHEN}[2]{%
  \algorithmicif\ {#1}\ \algorithmicthen\ {#2} %
  }

\newcommand{\INDSTATE}[1][1]{\State\hspace{\algorithmicindent}}

\begin{algorithmic}[1]
  \Statex
  \initially
    \State $p$ ; \hfill \comment{Identity of the local peer}
    \State $\mathcal{P} \leftarrow [\,]$;
    \hfill \comment{the partial view, sorted by age}
  \endInitially
  
  \act
    \Function{loop}{ } \hfill \comment{Every $\Delta$ time}
    \State $\mathcal{P} \leftarrow incrementAge(\mathcal{P})$;
    \State \textbf{let} $q \leftarrow getOldest(\mathcal{P})$;
    \State \textbf{let} $sample \leftarrow getSample(\mathcal{P}\setminus\left\{q\right\},\, \left \lceil{|\mathcal{P}|\over{2}} \right \rceil) \cup \left\{\langle p,\, 0 \rangle\right\}$;
    \State $sendTo(q,\, sample)$;
    \State \textbf{let} $sample'\leftarrow receiveFrom(q)$;
    \State $\mathcal{P} \leftarrow ((\mathcal{P} \setminus sample) \setminus \left\{ q \right\}) \cup sample'$;  \hfill \comment{update $\mathcal{P}$}
    \EndFunction
  \endAct
  
  \pas
    \Function{onExchange}{$o,\, sample$} \hfill \comment{$o: origin$}
    \State \textbf{let} $sample' \leftarrow getSample(\mathcal{P}\setminus \left\{o\right\} ,\, \left\lceil |\mathcal{P}|\over{2} \right\rceil )  \cup \left\{\langle p,\,0 \rangle\right\}$;
    \State $sendTo(o ,\, sample')$;
    \State $\mathcal{P} \leftarrow ((\mathcal{P} \setminus sample') \setminus \left\{ o \right\}) \cup sample$; \hfill \comment{update $\mathcal{P}$}
    \EndFunction
    \Statex
    \Function{onContact}{$o$} \hfill \comment{$o: origin$}
    \State \LINEFOR{\textbf{each} $q\in\mathcal{P}$}
    {$sendTo(q,\, 'fwdSubs',\, o)$;}
    \State \LINEFOR{$i \leftarrow 0$ \textbf{to} $c$}
    {\INDSTATE $sendTo(\mathcal{P}[\left\lfloor rand()*
        |\mathcal{P}|\right\rfloor],\, 'fwdSubs',\, o)$;}
    \EndFunction
    \Statex
    \Function{onFwdSubs}{$o$} \hfill \comment{$o: origin$}
    \If {$rand() < (1 / (|\mathcal{P}|+1))$}
    \State $\mathcal{P} \leftarrow
    \mathcal{P}\cup \left\{\langle o,\, 0 \rangle\right\}$;
    \Else
    \State $sendTo(\mathcal{P}[\left\lfloor rand()*
      |\mathcal{P}|\right\rfloor],\, 'fwdSubs',\, o)$;
    \EndIf
    \EndFunction
  \endPas
  
\end{algorithmic}
