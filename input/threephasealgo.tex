
\small
\SetKwProg{Function}{function}{}{}
\SetKwProg{INITIALLY}{INITIALLY}{}{}
\SetKwProg{PASSIVE}{PASSIVE THREAD}{}{}
\SetKwProg{ACTIVE}{ACTIVE THREAD}{}{}
\DontPrintSemicolon
\LinesNumbered

\INITIALLY {} {
  $B$ \hfill \Comment{buffer of packets} \;
  $b$ \hfill \Comment{number of advertised packets} \;
  $f$ \hfill \Comment{fanout $f \leq |P|$}
}
  
\ACTIVE {} {
  \Function{advertisementLoop ( )} { % \hfill \comm{every $\delta$ time} 
    \textbf{let} $advertiseTo \leftarrow getPeers(P,\,f)$ \hfill \Comment{$f$ distinct random peers from $P$} \;
  \textbf{let} $advertisement \leftarrow getIdentifiers(B,\,b)$ \hfill \Comment{$b$ distinct random packet Ids} \;
  \lFor{\textbf{each} $q \in advertiseTo$} {$sendTo(q,\, 'advertisement',\, advertisement)$}
  }
}

\PASSIVE {} {
  \Function{onAdvertisement ($o,\, ads$)} { % \hfill \comm{$o: advertiser$}
    \For {\textbf{each} $(id \in ads)$} {
      \lIf{$id \not\in B$}{$sendTo(o,\, 'request',\, id)$ }
    }
  }

  \BlankLine
  
  \Function{onRequest ($o,\, id$)} { % \hfill \comm{$o: requester$}
     \textbf{let} $packet \leftarrow getMessage(B,\,id)$ \hfill \Comment{get the requested packet from the buffer} \;
     $sendTo(o, \, packet)$ \hfill \Comment{finally send the packet} \;
  }
}

