
\small
\SetKwProg{Function}{function}{}{}
\DontPrintSemicolon
\LinesNumbered
  
\Function{onPeerDown ($q$)} { %\comm{$q$: crashed/departed peer}  
  \textbf{let} $occ \leftarrow 0$ \;

  \For{\textbf{each} $\langle n,\,age\rangle \in \mathcal{P}$} {
  %   \hfill \comm{remove and count}
    \If {$n=q$} {
       $\mathcal{P} \leftarrow \mathcal{P}\setminus \{\langle n,\,age\rangle \}$ \;
       $occ \leftarrow occ + 1$ \;
    }
  }

  \For{$i$ \textbf{from} $0$ \textbf{to} $occ$} {
           %  \hfill \comm{probabilistically duplicates}
    \If{$rand()>{1\div{(|\mathcal{P}|+occ}})$} {
       \textbf{let} $\langle n,\,\_ \,\rangle \leftarrow
         \mathcal{P}[\left\lfloor rand()*|\mathcal{P}|\right\rfloor]$ \;
       $\mathcal{P} \leftarrow \mathcal{P} \uplus \left\{\langle n,\, 0\rangle\right\}$
    }
  }
}

\BlankLine

\Function{onArcDown($q, age$)} {
%  \hfill \comm{$q$: arrival of the arc down}  
  $\mathcal{P} \leftarrow \mathcal{P}\setminus \{\langle q,\,age\rangle \}$ \;
  \textbf{let} $\langle n,\,\_ \,\rangle \leftarrow
  \mathcal{P}[\left\lfloor rand()*|\mathcal{P}|\right\rfloor]$ \;
  $\mathcal{P} \leftarrow \mathcal{P} \uplus \left\{\langle n,\, 0\rangle\right\}$ \;
  %  \hfill \comm{systematically duplicates}
}
